#!/usr/bin/env bash
set -euo pipefail

# trailfox-psql: project-specific psql wrapper to avoid shadowing system `psql`.
# Loads $ENV_FILE (defaults to same dir/../.env) when present and sets
# sensible defaults for host/port/user/db and ON_ERROR_STOP.

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ENV_FILE="${ENV_FILE:-$SCRIPT_DIR/../.env}"

if [ -f "$ENV_FILE" ]; then
  set -o allexport
  # shellcheck disable=SC1090
  source "$ENV_FILE"
  set +o allexport
fi

# Resolve defaults using either POSTGRES_* names (preferred by run_sql.sh)
# or the legacy DB_* names used by other scripts.
HOST="${POSTGRES_HOST:-${DB_HOST:-127.0.0.1}}"
PORT="${POSTGRES_PORT:-${DB_PORT:-5432}}"
DBNAME="${POSTGRES_DB:-${DB_NAME:-itinerarius}}"
USER="${POSTGRES_USER:-${DB_ADMIN_USER:-gisuser}}"

# If PGPASSWORD is not already set, prefer DB_ADMIN_PASSWORD from .env
if [ -z "${PGPASSWORD:-}" ] && [ -n "${DB_ADMIN_PASSWORD:-}" ]; then
  export PGPASSWORD="$DB_ADMIN_PASSWORD"
fi

DEFAULT_ARGS=( -v ON_ERROR_STOP=1 -h "$HOST" -p "$PORT" -U "$USER" -d "$DBNAME" )

# Execute psql with defaults; caller can override by passing explicit flags.
exec psql "${DEFAULT_ARGS[@]}" "$@"
