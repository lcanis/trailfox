#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

FORCE_RESET=false
IMPORT_VERB=""
PBF_FILE=""

usage() {
  cat <<'EOF'
Usage:
    ./bootstrap create|append|incremental /path/to/file.osm.pbf [--env-file path] [--bbox minlon,minlat,maxlon,maxlat]
EOF
}

if [ "$#" -ge 1 ] && ( [ "$1" = "-h" ] || [ "$1" = "--help" ] ); then
    usage
    exit 0
fi

IMPORT_VERB="${1:-}"
PBF_FILE="${2:-}"

if [ -z "$IMPORT_VERB" ] || [ -z "$PBF_FILE" ]; then
    usage
    exit 2
fi

case "$IMPORT_VERB" in
    create|append|incremental) ;;
    *)
        echo "Invalid verb: $IMPORT_VERB" >&2
        usage
        exit 2
        ;;
esac

shift 2

BBOX=""

while [ "$#" -gt 0 ]; do
    case "$1" in
        --env-file)
            ENV_FILE="$2"; shift 2;;
        --bbox)
            BBOX="$2"; shift 2;;
        -h|--help)
            usage; exit 0;;
        *)
            echo "Unknown option: $1" >&2; usage; exit 2;;
    esac
done

# Ensure we have an env file to load unless provided by --env-file
ENV_FILE="${ENV_FILE:-$SCRIPT_DIR/.env}"

source "$SCRIPT_DIR/bootstrap-common.sh"

echo "-- create DB"
"$SCRIPT_DIR/init-user"
"$SCRIPT_DIR/init-db" $([ "$IMPORT_VERB" = "create" ] && echo "--force-reset")

echo "-- import OSM data and run post-import maintenance"
if [ -n "$BBOX" ]; then
  "$SCRIPT_DIR/import" --bbox "$BBOX" "$IMPORT_VERB" "$PBF_FILE"
else
  "$SCRIPT_DIR/import" "$IMPORT_VERB" "$PBF_FILE"
fi

echo "-- apply API/tiles schemas"
"$SCRIPT_DIR/apply-schemas"

echo "done"
