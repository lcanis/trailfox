#!/usr/bin/env bash
set -euo pipefail

# Apply schema SQL scripts for API and tiles and count results.

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/bootstrap-common.sh"

ensure_command psql

if ! wait_for_postgres; then
  echo "Postgres unreachable" >&2
  exit 1
fi

export PGPASSWORD="${DB_ADMIN_PASSWORD:-}"

echo "-- applying api schema"
"${PSQL_DB[@]}" -v ON_ERROR_STOP=1 -v DB_ADMIN_USER="$DB_ADMIN_USER" -v APP_USER="$APP_USER" -f "$SCRIPT_DIR/sql/setup_api.sql"

echo "-- applying tiles schema"
"${PSQL_DB[@]}" -v ON_ERROR_STOP=1 -v DB_ADMIN_USER="$DB_ADMIN_USER" -v APP_USER="$APP_USER" -f "$SCRIPT_DIR/sql/setup_tiles.sql"

echo "-- ensuring app user can read itinerarius tables"
"${PSQL_DB[@]}" -v ON_ERROR_STOP=1 -c "GRANT USAGE ON SCHEMA itinerarius TO \"$APP_USER\"; GRANT SELECT ON ALL TABLES IN SCHEMA itinerarius TO \"$APP_USER\"; GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA itinerarius TO \"$APP_USER\";"

echo "-- results"
AMENITIES=$("${PSQL_DB[@]}" -tAc "SELECT COUNT(*) FROM itinerarius.amenities")
ROUTES=$("${PSQL_DB[@]}" -tAc "SELECT COUNT(*) FROM itinerarius.routes")
echo "amenities: $AMENITIES"
echo "routes: $ROUTES"
