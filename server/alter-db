#!/usr/bin/env bash
set -euo pipefail

# Simplified DB management script. Does NOT touch roles. Use --force-reset to
# drop & recreate the DB; when --force-reset is used the one-time `init-user-db`
# script will be invoked to (re)create users and API schema.

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/bootstrap-common.sh"

FORCE_RESET=false
while [ "$#" -gt 0 ]; do
  case "$1" in
    --force-reset)
      FORCE_RESET=true; shift;;
    -h|--help)
      echo "Usage: $0 [--force-reset]"; exit 0;;
    *) echo "Unknown arg: $1" >&2; exit 2;;
  esac
done

ensure_command psql
ensure_env_set DB_ADMIN_USER
ensure_env_set DB_ADMIN_PASSWORD

if ! wait_for_postgres; then
  echo "Postgres unreachable" >&2
  exit 1
fi

export PGPASSWORD="${DB_ADMIN_PASSWORD:-}"

if $FORCE_RESET; then
  echo "-- terminating connections to $DB_NAME"
  ATTEMPTS=0
  while true; do
    "${PSQL_POSTGRES[@]}" -c \
      "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$DB_NAME' AND pid <> pg_backend_pid();" >/dev/null || true

    SESSIONS=$("${PSQL_DB[@]}" -U "$DB_ADMIN_USER" -tAc \
      "SELECT count(*) FROM pg_stat_activity WHERE datname = '$DB_NAME' AND pid <> pg_backend_pid();")

    if [ "$SESSIONS" = "0" ]; then
      break
    fi
    ATTEMPTS=$((ATTEMPTS + 1))
    if [ "$ATTEMPTS" -ge 5 ]; then
      echo "-- warning: $SESSIONS connections remain after $ATTEMPTS attempts; proceeding to DROP and hope for best"
      break
    fi
    echo "-- $SESSIONS connections still present; retrying in 1s"
    sleep 1
  done

  echo "-- dropping database $DB_NAME"
  "${PSQL_POSTGRES[@]}" -c "DROP DATABASE IF EXISTS $DB_NAME;"

  # call init-user-db to (re)create roles and run setup SQLs
  echo "-- invoking init-user-db to recreate roles and apply setup SQL"
  "$SCRIPT_DIR/init-user-db"
fi

EXISTS_DB=$("${PSQL_POSTGRES[@]}" -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME';")
if [ "$EXISTS_DB" != "1" ]; then
  echo "-- creating database $DB_NAME owned by $DB_ADMIN_USER"
  "${PSQL_POSTGRES[@]}" -c "CREATE DATABASE $DB_NAME OWNER $DB_ADMIN_USER;"
else
  echo "-- database $DB_NAME exists (leave as-is)"
fi

echo "-- ensuring database owner is $DB_ADMIN_USER"
"${PSQL_POSTGRES[@]}" -c "ALTER DATABASE $DB_NAME OWNER TO $DB_ADMIN_USER;"

echo "-- granting connect to app user"
"${PSQL_POSTGRES[@]}" -c "GRANT CONNECT ON DATABASE $DB_NAME TO $APP_USER;"

echo "-- ensuring postgis extension and itinerarius schema exist"
"${PSQL_DB[@]}" -U "$DB_ADMIN_USER" <<EOSQL
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE SCHEMA IF NOT EXISTS itinerarius AUTHORIZATION "$DB_ADMIN_USER";
GRANT USAGE ON SCHEMA itinerarius TO "$APP_USER";

-- Make current and future tables readable by the app user (Martin/PostgREST).
GRANT SELECT ON ALL TABLES IN SCHEMA itinerarius TO "$APP_USER";
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA itinerarius TO "$APP_USER";

ALTER DEFAULT PRIVILEGES FOR ROLE "$DB_ADMIN_USER" IN SCHEMA itinerarius
  GRANT SELECT ON TABLES TO "$APP_USER";
ALTER DEFAULT PRIVILEGES FOR ROLE "$DB_ADMIN_USER" IN SCHEMA itinerarius
  GRANT USAGE, SELECT ON SEQUENCES TO "$APP_USER";
EOSQL

echo "-- alter-db completed"
